<nav class="bg-white shadow-lg fixed top-0 left-0 right-0 z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between h-16">
      <div class="flex">
        <!-- Logo -->
        <div class="flex-shrink-0 flex items-center">
          <%= link_to root_path, class: "text-xl font-bold text-gray-800 hover:text-gray-600" do %>
            Montford Dons
          <% end %>
        </div>

        <!-- Navigation Links -->
        <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
          <%= link_to "Dashboard", root_path, 
              class: "text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium #{current_page?(root_path) ? 'border-indigo-500' : 'border-transparent'}" %>
          
          <%= link_to "Payments", payments_path, 
              class: "text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium #{current_page?(payments_path) ? 'border-indigo-500 text-gray-900' : 'border-transparent'}" %>
          
          <%= link_to "Weeks", weeks_path, 
              class: "text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium #{current_page?(weeks_path) ? 'border-indigo-500 text-gray-900' : 'border-transparent'}" %>
          <% if can?(:manage, ChargeType) %>
          <%= link_to "Charge Types", charge_types_path, 
              class: "text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium #{current_page?(charge_types_path) ? 'border-indigo-500 text-gray-900' : 'border-transparent'}" %>
          <% end %>
          <% if can?(:manage, User) %>
            <%= link_to "Users", users_path, 
                class: "text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium #{current_page?(users_path) ? 'border-indigo-500 text-gray-900' : 'border-transparent'}" %>
          <% end %>
        </div>
      </div>

      <!-- Right side menu -->
      <div class="hidden sm:ml-6 sm:flex sm:items-center">

        <% if authenticated? %>
          <div class="ml-3 relative">
            <div class="flex items-center space-x-4">
              
            <div class="relative" id="user-dropdown">
              <button type="button" class="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
                <span class="sr-only">Open user menu</span>
                <span class="inline-block h-8 w-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center content-center font-bold">
                  <%= current_user.initials %>
                </span>
                <span class="ml-2 text-gray-800 font-medium"><%= current_user.name if current_user&.respond_to?(:name) %></span>
                <svg class="ml-1 h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20" stroke="currentColor" id="dropdown-arrow">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7l3-3 3 3m0 6l-3 3-3-3" />
                </svg>
              </button>
              <div class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-50" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button" tabindex="-1" id="user-menu">
                <div class="py-1" role="none">
                  <%= link_to "Edit Profile", edit_user_path(current_user), class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100", role: "menuitem", tabindex: "-1" %>
                  <%= button_to "Sign out", session_path, method: :delete, class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left", role: "menuitem", tabindex: "-1", data: { turbo_method: :delete } %>
                </div>
              </div>
            </div>
            </div>
          </div>
        <% else %>
          <%= link_to "Sign in", new_session_path, 
              class: "bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-md text-sm font-medium" %>
        <% end %>
      </div>

      <!-- Mobile menu button -->
      <div class="sm:hidden flex items-center">
        <button type="button" class="bg-white inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-controls="mobile-menu" aria-expanded="false" onclick="toggleMobileMenu()">
          <span class="sr-only">Open main menu</span>
          <!-- Hamburger icon -->
          <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile menu -->
  <div class="sm:hidden hidden" id="mobile-menu">
    <div class="pt-2 pb-3 space-y-1">
      <%= link_to "Dashboard", root_path, 
          class: "bg-indigo-50 border-indigo-500 text-indigo-700 block pl-3 pr-4 py-2 border-l-4 text-base font-medium #{'bg-indigo-50 border-indigo-500 text-indigo-700' if current_page?(root_path)}" %>
      
      <%= link_to "Payments", payments_path, 
          class: "border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800 block pl-3 pr-4 py-2 border-l-4 text-base font-medium #{'bg-indigo-50 border-indigo-500 text-indigo-700' if current_page?(payments_path)}" %>
      
      <%= link_to "Weeks", weeks_path, 
          class: "border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800 block pl-3 pr-4 py-2 border-l-4 text-base font-medium #{'bg-indigo-50 border-indigo-500 text-indigo-700' if current_page?(weeks_path)}" %>
      <% if can?(:manage, ChargeType) %>
      <%= link_to "Charge Types", charge_types_path, 
          class: "border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800 block pl-3 pr-4 py-2 border-l-4 text-base font-medium #{'bg-indigo-50 border-indigo-500 text-indigo-700' if current_page?(charge_types_path)}" %>
      <% end %>
      <% if can? :manage, User %>
        <%= link_to "Users", users_path, 
            class: "border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800 block pl-3 pr-4 py-2 border-l-4 text-base font-medium #{'bg-indigo-50 border-indigo-500 text-indigo-700' if current_page?(users_path)}" %>
      <% end %>
    </div>
    
    <div class="pt-4 pb-3 border-t border-gray-200">
      <% if authenticated? %>
        <div class="flex items-center px-4">
          <div class="ml-3">
            <div class="text-base font-medium text-gray-800">User Menu</div>
          </div>
        </div>
        <div class="mt-3 space-y-1">
          <%= button_to "Sign out", session_path, 
              method: :delete, 
              class: "block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100",
              data: { confirm: "Are you sure you want to sign out?" } %>
        </div>
      <% else %>
        <div class="mt-3 space-y-1">
          <%= link_to "Sign in", new_session_path, 
              class: "block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100" %>
        </div>
      <% end %>
    </div>
  </div>
</nav>

<script>
  function toggleMobileMenu() {
    const menu = document.getElementById('mobile-menu');
    menu.classList.toggle('hidden');
  }

  // User dropdown functionality - Turbo compatible
  function initializeUserDropdown() {
    const dropdown = document.getElementById('user-dropdown');
    const button = document.getElementById('user-menu-button');
    const menu = document.getElementById('user-menu');
    const arrow = document.getElementById('dropdown-arrow');
    
    if (dropdown && button && menu && arrow && !button.dataset.initialized) {
      button.dataset.initialized = 'true'; // Prevent duplicate initialization
      let hoverTimer;
      
      // Show dropdown on hover
      function showDropdown() {
        clearTimeout(hoverTimer);
        menu.classList.remove('hidden');
        button.setAttribute('aria-expanded', 'true');
        arrow.style.transform = 'rotate(180deg)';
        arrow.style.color = '#6b7280'; // text-gray-500
      }
      
      // Hide dropdown with delay
      function hideDropdown() {
        hoverTimer = setTimeout(() => {
          menu.classList.add('hidden');
          button.setAttribute('aria-expanded', 'false');
          arrow.style.transform = 'rotate(0deg)';
          arrow.style.color = '#9ca3af'; // text-gray-400
        }, 100); // Small delay to allow moving between button and menu
      }
      
      // Event listeners for button
      button.addEventListener('mouseenter', showDropdown);
      button.addEventListener('mouseleave', hideDropdown);
      
      // Event listeners for dropdown menu
      menu.addEventListener('mouseenter', showDropdown);
      menu.addEventListener('mouseleave', hideDropdown);
      
      // Click to toggle (for touch devices)
      button.addEventListener('click', function(e) {
        e.preventDefault();
        if (menu.classList.contains('hidden')) {
          showDropdown();
        } else {
          hideDropdown();
        }
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!dropdown.contains(e.target)) {
          menu.classList.add('hidden');
          button.setAttribute('aria-expanded', 'false');
          arrow.style.transform = 'rotate(0deg)';
          arrow.style.color = '#9ca3af';
        }
      });
    }
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initializeUserDropdown);
  
  // Re-initialize after Turbo navigation (when content changes)
  document.addEventListener('turbo:load', initializeUserDropdown);
  document.addEventListener('turbo:render', initializeUserDropdown);
</script>
